<!DOCTYPE html>
<html>
<head>
        <meta name="apple-mobile-web-app-title" content="github文件读写" />
<META HTTP-EQUIV="pragma" CONTENT="no-cache" /> 
<meta name="apple-mobile-web-app-capable" content="yes" /> 
<meta name="apple-touch-fullscreen" content="yes" />
<meta http-equiv="Content-Type" content="application/xhtml+xml;charset=utf-8" />
<META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate"> 
<META HTTP-EQUIV="expires" CONTENT="0">
<meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

	
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="tinyblog" content="v1.2">
	<title>this is title</title>

	<link href="//cdn.bootcss.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
	<link href="//cdn.bootcss.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="./css/mystyle.css" rel="stylesheet">

	<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
	<script src="//cdn.bootcss.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

	<!--markdown-->
	<link rel="stylesheet" href="./editor.md/css/editormd.preview.min.css" />
	<script src="/editor.md/lib/marked.min.js"></script>
	<script src="/editor.md/lib/prettify.min.js"></script>
	<script src="/editor.md/lib/raphael.min.js"></script>
	<script src="/editor.md/lib/underscore.min.js"></script>
	<script src="/editor.md/lib/sequence-diagram.min.js"></script>
	<script src="/editor.md/lib/flowchart.min.js"></script>
	<script src="/editor.md/lib/jquery.flowchart.min.js"></script>
	<script src="/editor.md/editormd.min.js"></script>
	<!--markdown-->
	<script src="/js/core2.js?i=2"></script>
</head>

<body>
	<!-- Navigation -->
	<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container-fluid">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" id="btnNav">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
				<a class="navbar-brand" href="#" id="header">BlogName</a>
			</div>
			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav" id="nav2">
				</ul>
			</div>
			<!-- /.navbar-collapse -->
		</div>
		<!-- /.container -->
	</nav>

	<div class="container-fluid ">
		<div class="row">

			<div class="col-sm-3 col-md-2 sidebar ">

				<ul class="nav nav-sidebar" id="nav">

					<!--文章列表-->
				</ul>
			</div>
			<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
				<!--<div class="panel panel-white post ">
 +					<input type="button" value='eval'  onclick="eval(txt.value)" /><input type="button" value='turn'  onclick="$('#txt').toggle();" />
 +					<textarea id="txt" style="display:none;width:100%;height:100px;font: 0.7em Arial, Helvetica, sans-serif;"></textarea>
  				</div>-->
				<!--正文-->
				<h1 class="page-header" id="title">About Me</h1>
				<div id="article"> HelloWorld! 你好 世界！ </div>

				<div class="panel panel-white post " id="comments">
					<div class="post-footer">
						<div class="input-group">
							<input id="comment_txt" class="form-control" placeholder="Add a comment" type="text">
							<span class="input-group-addon">
                        <a href="#"><i class="fa fa-edit" onclick="login()"></i></a>  
                    </span>
						</div>
						<ul class="comments-list" id="commentsList">
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
					<h4 class="modal-title" id="myModalLabel">登录</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="txt_departmentlevel">Username</label>
						<input type="text" name="txt_departmentlevel" class="form-control" id="txt_username" placeholder="Github用户名">
					</div>
					<div class="form-group">
						<label for="txt_statu">Password</label>
						<input type="password" name="txt_statu" class="form-control" id="txt_password" placeholder="Github密码">
					</div>
					<div class="alert alert-warning" role="alert" id="tips">我们不会获取您的用户名和密码,评论直接通过 HTTPS 与 Github API交互,如果您开启了两步验证,请在博客的Github issues 下添加 Comment</div>
				</div>
				<div class="modal-footer">
					<button type="button" id="btn_subComment" class="btn btn-primary" data-dismiss="modal" onclick="subComment()">提交</button>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
//alert(location.host)
    var str=location.pathname;
str=str.substr(1)
alert(str.replace(/^(\/)|(\/)$/g, ''))
var issuesList;
var issuesHTML;
alert()
$(document).ready(function() {
    var webURL = window.location.href;
    var splitFlag = "http://";
    if (webURL.substring(0, 5) == "https") {
        splitFlag = "https://";
    }
    var user = "docfeng";//webURL.split(splitFlag)[1].split(".")[0];
    //var repos_name=user + '.github.io';
    var repos_name="blog4";
    //user = 'yanghanqing';
    blogListURL = 'https://api.github.com/repos/' + user + '/' + repos_name + '/contents/blog';
    alert()
    if(!location.pathname.substr(-5).match(/\./)){
        blogListURL = 'https://api.github.com/repos/' + user + '/' + repos_name + '/contents/'+location.pathname.replace(/^(\/)|(\/)$/g, '');
        alert(blogListURL)
    }
    issuesList = 'https://api.github.com/repos/' + user + '/' + repos_name + '/issues';
    issuesHTML = 'https://github.com/' + user + '/' + repos_name + '/issues'
    readmeURL = 'https://raw.githubusercontent.com/' + user + '/' + repos_name + '/master/About Me.md';

    $("#header").text(user + "'s Blog");
    $("#commentsList").removeAttr('data_comments_url');
    $("#tips").html("我们不会获取您的用户名和密码,评论直接通过 HTTPS 与 Github API交互,<br>如果您开启了两步验证,请在博客的<a  target=\"_blank\" href=\"" + issuesHTML + "\">Github issues</a>下添加 Comment");

    var titleString = getTitleString();

    //set Blog list    
    $.getJSON(blogListURL, function(json) {
        for (var i = 0; i < json.length; i++) {
            var name = json[i].name; // Blog title
            var blogURL = json[i].download_url; //Blog Raw Url
            // add blog list elements
            var new_li = $("<li></li>");
            var new_a = $("<a></a>")

            var type = "markdown";
            // delete '.md'
            if (name.substr(-3, 3) == ".md") {
                name = name.substr(0, name.length - 3);
            } else if (name.substr(-5, 5) == ".html") {
                name = name.substr(0, name.length - 5);
                type = "html";
            }
            // console.log(name);
            // console.log(titleString);
            if (name == titleString) {
                $("#title").text(name);
                readmeURL = blogURL;
            }

            new_a.text(name);
            //update content
            new_a.attr("data_blogURL", blogURL);
            new_a.attr("data_name", name);
            //new_a.attr("href", "?title=" + name);
            new_a.attr("href", "#");
            new_a.attr("data_type", type);
            new_a.attr("onclick", "setBlogTxt(this)");
            new_li.append(new_a);
            $('#nav').append(new_li);
            $('#nav2').append(new_li.clone());
        }
        //set readme 
        $.get(readmeURL, function(result) {
            $("#title").show();
            $("#article").html("");

            testEditormdView = editormd.markdownToHTML("article", {
                markdown: result, //+ "\r\n" + $("#append-test").text(),
                // htmlDecode: true, // 开启 HTML 标签解析，为了安全性，默认不开启
                htmlDecode: "style,script,iframe", // you can filter tags decode
                //toc             : false,
                tocm: true, // Using [TOCM]
                //tocContainer    : "#custom-toc-container", // 自定义 ToC 容器层
                //gfm             : false,
                //tocDropdown     : true,
                // markdownSourceCode : true, // 是否保留 Markdown 源码，即是否删除保存源码的 Textarea 标签
                emoji: true,
                taskList: true,
                tex: true, // 默认不解析
                flowChart: true, // 默认不解析
                sequenceDiagram: true, // 默认不解析
            });
        });
    });
})

function setBlogTxt(obj) {
    // 隐藏Button
    if (!$('#btnNav').is(':hidden')) {
        $('#btnNav').click();
    }

    obj = $(obj);
    var blogName = obj.attr("data_name");
    var blogURL = obj.attr("data_blogURL");
    var type = obj.attr("data_type");
    $("#title").text(blogName);
    $("#article").html("loading . . .");
    // set blog content     
    $.get(blogURL, function(result) {
        $("#title").show();
        if (type == "markdown") {
            $("#article").html("");
            testEditormdView = editormd.markdownToHTML("article", {
                markdown: result, //+ "\r\n" + $("#append-test").text(),
                // htmlDecode: true, // 开启 HTML 标签解析，为了安全性，默认不开启
                htmlDecode: "style,script,iframe", // you can filter tags decode
                //toc             : false,
                tocm: true, // Using [TOCM]
                //tocContainer    : "#custom-toc-container", // 自定义 ToC 容器层
                //gfm             : false,
                //tocDropdown     : true,
                // markdownSourceCode : true, // 是否保留 Markdown 源码，即是否删除保存源码的 Textarea 标签
                emoji: true,
                taskList: true,
                tex: true, // 默认不解析
                flowChart: true, // 默认不解析
                sequenceDiagram: true, // 默认不解析
            });

        } else {
            $("#title").hide();
            $("#article").html(result);
        }
    });
    //get comments_url
    setCommentURL(issuesList, blogName);
}

function setCommentURL(issuesList, blogName) {
    $("#comments").show();
    console.log("获取并设置评论区");
    $.ajax({
        type: "GET",
        url: issuesList,
        dataType: 'json',
        async: false,
        success: function(json) {
            for (var i = 0; i < json.length; i++) {
                var title = json[i].title; // Blog title
                var comments_url = json[i].comments_url;
                if (title == blogName) {
                    console.log("该文章存在评论")
                    $('#commentsList').attr("data_comments_url", comments_url);
                    setComment(comments_url);
                    break;
                }
                $("#commentsList").children().remove();
                $("#commentsList").removeAttr('data_comments_url');

            }
        }
    });


}



function setComment(commentURL) {
    $('#commentsList').children().remove();

    $.getJSON(commentURL, function(json) {
        for (var i = 0; i < json.length; i++) {
            var avatar_url = json[i].user.avatar_url; // avatar_url
            var user = json[i].user.login;
            //var updated_at = json[i].updated_at;
            var updated_at = new Date(json[i].updated_at).toLocaleString();
            var body = json[i].body;

            // add blog list elements
            var commentHtml =
                "<li class=\"comment\">" +
                "<a class=\"pull-left\" href=\"#\"><img class=\"avatar\" src=\"" + avatar_url +
                "\" alt=\"avatar\"></a><div class=\"comment-body\"><div class=\"comment-heading\"><h4 class=\"user\">" + user +
                "</h4><h5 class=\"time\">" + updated_at +
                "</h5></div><p>" + body +
                "</p></div></li>";

            var new_obj = $(commentHtml);
            $('#commentsList').append(new_obj);
        }
    });
}

//显示登录框
function login() {
  var data=localStorage.getItem("data");
  if(data){
      data=JSON.parse(data);
      $("#txt_token").val(data.token);
      subComment(data);
  }else{
    $('#myModal').modal();
  }
}

function setData(){
    var data={};
    var USERNAME = data.username = $("#txt_username").val();
    var PASSWORD = data.password = document.getElementById("txt_password").value; //
    var TOKEN = data.token = $("#txt_token").val();
    alert(JSON.stringify(data));
    subComment(data);
}
function subComment(data) {
    //var console={};
    //console.log=function(txt){alert(txt)}
    var title = $("#title").text();
    var author="";
    if (data.token == undefined || data.token == null || data.token == "") {
       author="Basic " + btoa(data.username + ":" + data.password);
    }else{
      author="token "+data.token;
    }
    // 未开启评论
    if (typeof($("#commentsList").attr("data_comments_url")) == "undefined") {
        if (title == undefined || title == null || title == "") {
            return;
        }

        var createIssueJson = "{\"title\": \"" + title + "\"}";
        $.ajax({
            type: "POST",
            url: issuesList,
            dataType: 'json',
            async: false,
            headers: {
                "Authorization": author//"Basic " + btoa(USERNAME + ":" + PASSWORD)
            },
            data: createIssueJson,
            success: function() {
                console.log('开启评论成功:' + title);
                //重新遍历issue list
                setCommentURL(issuesList, title);
                console.log('重新遍历 issuesList 完成');

            }
        });
    }
    console.log("准备提交评论");
    // 已开启评论
    if (typeof($("#commentsList").attr("data_comments_url")) != "undefined") {
        var issueURL = $("#commentsList").attr("data_comments_url");
        var comment = $("#comment_txt").val();
        var commentJson = "{\"body\": \"" + comment + "\"}";
        console.log(comment);
        if (comment == "") {
            alert("评论不能为空");
            return;
        }

        $.ajax({
            type: "POST",
            url: issueURL,
            dataType: 'json',
            async: false,
            headers: {
                "Authorization": author//"Basic " + btoa(USERNAME + ":" + PASSWORD)
            },
            data: commentJson,
            success: function() {
                console.log('评论成功');

                // 更新评论区
                if (title != null) {
                    setCommentURL(issuesList, title);
                    localStorage.setItem("data",JSON.stringify(data));
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                alert("账号密码错误,或者开启了两步验证");
            }
        });
    } else {
        console.log("未开启评论")
    }
}


function getTitleString() {
    var reg = new RegExp("(^|&)" + "title" + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return decodeURI(r[2]);
    return null;
}

</script>
</html>
